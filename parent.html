<!doctype html>
<html>
  <head>
    <title>Parent Window</title>
  </head>
  <body>
    <h1>Parent Window</h1>

    <div id="messages"></div>

    <iframe
      id="childFrame"
      src="child.html"
      width="600"
      height="400"
      style="color: red"
    ></iframe>

    <script>
      const iframe = document.getElementById("childFrame");
      const messagesDiv = document.getElementById("messages");

      // Listen for messages from child
      window.addEventListener("message", (event) => {
        // Validate the origin - only accept messages from same origin
        const expectedOrigin = window.location.origin;
        if (event.origin !== expectedOrigin) {
          console.log("Ignored message from unexpected origin:", event.origin);
          return;
        }

        // Only respond to messages from our child iframe (not extension messages)
        if (!event.data || typeof event.data !== "object" || !event.data.type) {
          console.log("Ignored message without expected structure:", event.data);
          return;
        }

        // Only respond to child-to-parent messages (not responses)
        if (event.data.type === "response") {
          console.log("Ignored response message (preventing loop)");
          return;
        }

        console.log("Parent received:", event.data);

        messagesDiv.innerHTML += `<p>Got: ${JSON.stringify(event.data)}</p>`;

        // Send response back to child
        event.source.postMessage(
          {
            type: "response",
            data: "Hello back from parent!",
          },
          event.origin,
        );
      });
    </script>
  </body>
</html>
